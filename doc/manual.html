<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>PSX Manual</title><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"><meta name="description" content="This is the offical manual of the PSX framework."><link href="default.css" type="text/css" rel="stylesheet"><script src="default.js" type="text/javascript"></script><script type="text/javascript">
	  $(document).ready(function(){
	    prettyPrint();
	  });
	  </script></head><body><div class="container"><div lang="en" class="book"><div class="titlepage"><div><div><h1 class="title"><a name="d54e1"></a>PSX Manual</h1></div><div><div class="abstract"><p class="title"><b>Abstract</b></p><p>This is the offical manual of the PSX framework.</p></div></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="chapter"><a href="#introduction">1. Introduction</a></span></dt><dt><span class="chapter"><a href="#installation">2. Installation</a></span></dt><dd><dl><dt><span class="sect1"><a href="#installation-manual">2.1. Manual</a></span></dt><dt><span class="sect1"><a href="#installation-composer">2.2. Composer</a></span></dt></dl></dd><dt><span class="chapter"><a href="#configuration">3. Configuration</a></span></dt><dt><span class="chapter"><a href="#developing-restful-api">4. Developing a RESTful API</a></span></dt><dd><dl><dt><span class="sect1"><a href="#d54e132">4.1. Setting up the table</a></span></dt><dt><span class="sect1"><a href="#d54e147">4.2. Creating the record</a></span></dt><dt><span class="sect1"><a href="#d54e157">4.3. Creating the handler</a></span></dt><dt><span class="sect1"><a href="#d54e170">4.4. Creating the table</a></span></dt><dt><span class="sect1"><a href="#d54e185">4.5. The API endpoint</a></span></dt><dd><dl><dt><span class="sect2"><a href="#d54e206">4.5.1. Receiving</a></span></dt><dt><span class="sect2"><a href="#d54e294">4.5.2. Inserting</a></span></dt></dl></dd><dt><span class="sect1"><a href="#d54e328">4.6. Conclusion</a></span></dt></dl></dd><dt><span class="chapter"><a href="#api-authorization">5. API authorization</a></span></dt><dd><dl><dt><span class="sect1"><a href="#d54e357">5.1. Basic authentication</a></span></dt><dt><span class="sect1"><a href="#d54e367">5.2. Oauth authentication</a></span></dt></dl></dd><dt><span class="chapter"><a href="#oauth-based-api-authorization">6. Oauth implementation</a></span></dt><dd><dl><dt><span class="sect1"><a href="#d54e382">6.1. Setting up the table</a></span></dt><dt><span class="sect1"><a href="#d54e394">6.2. Oauth endpoints</a></span></dt><dd><dl><dt><span class="sect2"><a href="#temporary-credential-request">6.2.1. Temporary Credential Request</a></span></dt><dt><span class="sect2"><a href="#resource-owner-authorization">6.2.2. Resource Owner Authorization</a></span></dt><dt><span class="sect2"><a href="#token-request">6.2.3. Token Request</a></span></dt></dl></dd><dt><span class="sect1"><a href="#d54e459">6.3. Protect the API endpoint</a></span></dt><dd><dl><dt><span class="sect2"><a href="#d54e469">6.3.1. Inserting</a></span></dt></dl></dd><dt><span class="sect1"><a href="#d54e484">6.4. Conclusion</a></span></dt></dl></dd><dt><span class="chapter"><a href="#help">7. Help</a></span></dt></dl></div><div class="list-of-examples"><p><b>List of Examples</b></p><dl><dt>4.1. <a href="#d54e140"><span class="database">news</span> table</a></dt><dt>4.2. <a href="#d54e152">library/Test/News/Record.php</a></dt><dt>4.3. <a href="#d54e165">library/Test/News/Handler.php</a></dt><dt>4.4. <a href="#d54e180">library/Test/News/Table.php</a></dt><dt>4.5. <a href="#d54e201">module/api/news.php</a></dt><dt>4.6. <a href="#d54e230">module/api/news.php (implement <code class="methodname">getNews</code> method)</a></dt><dt>4.7. <a href="#d54e249">module/api/news.php (implement <code class="methodname">setWriterConfig</code> method)</a></dt><dt>4.8. <a href="#d54e271">library/Example/News/Record.php (implement <code class="methodname">export</code> method)</a></dt><dt>4.9. <a href="#d54e284">Sample GET request</a></dt><dt>4.10. <a href="#d54e289">Sample GET response</a></dt><dt>4.11. <a href="#d54e305">module/api/news.php (implement <code class="methodname">insertNews</code> method)</a></dt><dt>4.12. <a href="#d54e318">Sample POST request</a></dt><dt>4.13. <a href="#d54e323">Sample POST response</a></dt><dt>5.1. <a href="#d54e362">module/api/news.php (add basic authentication)</a></dt><dt>5.2. <a href="#d54e372">module/api/news.php (add oauth authentication)</a></dt><dt>6.1. <a href="#d54e387"><span class="database">request</span> table</a></dt><dt>6.2. <a href="#d54e431">module/api/request.php</a></dt><dt>6.3. <a href="#d54e444">module/api/auth.php</a></dt><dt>6.4. <a href="#d54e454">module/api/access.php</a></dt><dt>6.5. <a href="#d54e464">module/api/news.php (add oauth authentication)</a></dt><dt>6.6. <a href="#d54e474">Sample POST request</a></dt><dt>6.7. <a href="#d54e479">Sample POST response</a></dt></dl></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="introduction"></a>Chapter&nbsp;1.&nbsp;Introduction</h1></div></div></div><p>PSX is a framework written in PHP to create RESTful APIs. It helps you building clean URLs serving web standard 
		formats like JSON, XML, Atom and RSS. At the core PSX is build of three parts. A handler system (similar to repositories 
		in doctrine) wich abstracts away the actual SQL queries from the domain logic. An routing system wich executes the 
		fitting controller method depending on	the location of the controller and the annotation of the method. And an flexible 
		data system to convert data records from the database into different formats like JSON, XML, Atom and RSS. PSX uses a 
		lightweight DI container to handle dependencies (but is also compatible with the symfony DI container). The controller 
		can return request or response filter wich can react or modify the HTTP request or response. PSX offers some basic 
		request filter to handle i.e. Basic or Oauth authentication. In addition PSX offers some cool components to use and 
		implement OAuth, OpenID, Opengraph, Opensocial, Opensearch, PubSubHubbub, WebFinger, Atom, and RSS. At the 
		<a class="ulink" href="http://example.phpsx.org/" target="_top">example</a> page you can see sample implementations using various PSX classes.</p></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="installation"></a>Chapter&nbsp;2.&nbsp;Installation</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="sect1"><a href="#installation-manual">2.1. Manual</a></span></dt><dt><span class="sect1"><a href="#installation-composer">2.2. Composer</a></span></dt></dl></div><p>If you want use PSX fully including the routing mechanism you have to download the framework manually because 
		the requests must go to the index.php. If you only want use specific classes of PSX you can install it via Composer.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="installation-manual"></a>2.1.&nbsp;Manual</h2></div></div></div><p>You can download the current version of psx from the offical website <a class="ulink" href="http://phpsx.org" target="_top">phpsx.org</a>.
			Put the folder on your web or local server. Goto http://host/path/to/psx/public and if you see a website with the title
			"Template sample" psx is running successfully.</p></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="installation-composer"></a>2.2.&nbsp;Composer</h2></div></div></div><p>If you use classes of PSX in your application you can add PSX as dependency in your composer.json file. The
			package name is psx/psx. More informations at <a class="ulink" href="http://packagist.org/packages/psx/psx" target="_top">packagist.org</a>.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="configuration"></a>Chapter&nbsp;3.&nbsp;Configuration</h1></div></div></div><p>The config is an php array with key value pairs. You must change the key "psx_url" so that it
		points to the psx public root. All other entries are optional. The following table describes each entry.</p><div class="informaltable"><table class="table" border="1"><colgroup><col><col></colgroup><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td>psx_url</td><td>The absolute url to the psx public folder (i.e. http://127.0.0.1/psx/public).</td></tr><tr><td>psx_dispatch</td><td>Where we get the input path normally index.php/. If you use .htaccess to redirect all requestst to the index.php you can also set this to ''.</td></tr><tr><td>psx_timezone</td><td>The default timezone</td></tr><tr><td>psx_gzip</td><td>Whether to gzip the output of psx. The content gets only compressed if the browser support gzip.</td></tr><tr><td>psx_debug</td><td>Whether psx runs in debug mode or not. If not the error reporting is set to 0.</td></tr><tr><td>psx_module_default</td><td>The module wich is loaded by default</td></tr><tr><td>psx_template_dir</td><td>This is the name of an folder in the template dir</td></tr><tr><td>psx_sql_host</td><td>Your sql host</td></tr><tr><td>psx_sql_user</td><td>Your sql user</td></tr><tr><td>psx_sql_pw</td><td>Your sql pw</td></tr><tr><td>psx_sql_db</td><td>Your sql db</td></tr><tr><td>psx_path_cache</td><td>The path to the cache folder. You can set this i.e. to /tmp.</td></tr><tr><td>psx_path_library</td><td>The path to the library folder. If this is null the classes are loaded from the include_path</td></tr><tr><td>psx_path_module</td><td>The path to the module folder</td></tr><tr><td>psx_path_template</td><td>The path to the template folder</td></tr></tbody></table></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="developing-restful-api"></a>Chapter&nbsp;4.&nbsp;Developing a RESTful API</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="sect1"><a href="#d54e132">4.1. Setting up the table</a></span></dt><dt><span class="sect1"><a href="#d54e147">4.2. Creating the record</a></span></dt><dt><span class="sect1"><a href="#d54e157">4.3. Creating the handler</a></span></dt><dt><span class="sect1"><a href="#d54e170">4.4. Creating the table</a></span></dt><dt><span class="sect1"><a href="#d54e185">4.5. The API endpoint</a></span></dt><dd><dl><dt><span class="sect2"><a href="#d54e206">4.5.1. Receiving</a></span></dt><dt><span class="sect2"><a href="#d54e294">4.5.2. Inserting</a></span></dt></dl></dd><dt><span class="sect1"><a href="#d54e328">4.6. Conclusion</a></span></dt></dl></div><p>This is the main chapter of the manual wich explains step by step howto develop a RESTful API
		based on PSX. In this example we create a simple news API where you can create and receive news.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d54e132"></a>4.1.&nbsp;Setting up the table</h2></div></div></div><p>For our example we need a simple table called <span class="property">news</span> where all records are stored.</p><div class="example"><a name="d54e140"></a><p class="title"><b>Example&nbsp;4.1.&nbsp;<span class="database">news</span> table</b></p><div class="example-contents"><pre class="programlisting prettyprint">
CREATE TABLE IF NOT EXISTS `news` (
  `id` int(10) NOT NULL AUTO_INCREMENT,
  `userId` int(10) NOT NULL,
  `title` varchar(128) NOT NULL,
  `text` text NOT NULL,
  `date` datetime NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 ;
				</pre></div></div><br class="example-break"></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d54e147"></a>4.2.&nbsp;Creating the record</h2></div></div></div><p>The record represents an row from an database. If we post a news to the api endpoint this record is created
			and the setter methods are called. This is the place where you have to validate the user data.</p><div class="example"><a name="d54e152"></a><p class="title"><b>Example&nbsp;4.2.&nbsp;library/Test/News/Record.php</b></p><div class="example-contents"><pre class="programlisting prettyprint">
&lt;?php

namespace Test\News;

use PSX\Data\RecordAbstract;

class Record extends RecordAbstract
{
	protected $id;
	protected $userId;
	protected $title;
	protected $text;
	protected $date;

	protected $_date;

	public function setId($id)
	{
		$this-&gt;id = $id;
	}

	public function setUserId($userId)
	{
		$this-&gt;userId = $userId;
	}

	public function setTitle($title)
	{
		$this-&gt;title = $title;
	}

	public function setText($text)
	{
		$this-&gt;text = $text;
	}

	public function setDate($date)
	{
		$this-&gt;date = $date;
	}

	public function getDate()
	{
		if($this-&gt;_date === null)
		{
			$this-&gt;_date = new DateTime($this-&gt;date);
		}

		return $this-&gt;_date;
	}
}
				</pre></div></div><br class="example-break"></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d54e157"></a>4.3.&nbsp;Creating the handler</h2></div></div></div><p>The handler is a concept similar to a repository in doctrine wich abstracts the sql queries
			away from the controller. Instead of creating sql queries you should add "<code class="methodname">getByFoo</code>" methods 
			to the handler. The Handler is also responsible to create, update and delete an record. In our case
			the default select methods wich are provided by the HandlerAbstract are sufficient for our api so we dont
			have to add additional methods.</p><div class="example"><a name="d54e165"></a><p class="title"><b>Example&nbsp;4.3.&nbsp;library/Test/News/Handler.php</b></p><div class="example-contents"><pre class="programlisting prettyprint">
&lt;?php

namespace Test\News;

use PSX\Data\HandlerAbstract;

class Handler extends HandlerAbstract
{
}
				</pre></div></div><br class="example-break"></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d54e170"></a>4.4.&nbsp;Creating the table</h2></div></div></div><p>Note the key parts of PSX are the records and handler the table class wich we now create is only a helper
			class for the handler in order to retrieve records from an mysql table via PDO. You are free to implement your own 
			HandlerInterface and use an ORM like doctrine, simple SQL queries or any other system to CRUD records.</p><p>The table represents an database table. It contains the table name wich columns are available and the 
			relations to other tables. In this example we have no relation to another table but to give an example the
			<code class="methodname">getConnection</code> method is implemented</p><div class="example"><a name="d54e180"></a><p class="title"><b>Example&nbsp;4.4.&nbsp;library/Test/News/Table.php</b></p><div class="example-contents"><pre class="programlisting prettyprint">
&lt;?php

namespace Test\News;

use PSX\Sql\TableAbstract;

class Table extends TableAbstract
{
	public function getName()
	{
		return 'news';
	}

	public function getColumns()
	{
		return array(
			'id' =&gt; self::TYPE_INT | 10 | self::PRIMARY_KEY | self::AUTO_INCREMENT,
			'userId' =&gt; self::TYPE_INT | 10,
			'title' =&gt; self::TYPE_VARCHAR | 64,
			'text' =&gt; self::TYPE_TEXT,
			'date' =&gt; self::TYPE_DATETIME,
		);
	}

	/*
	public function getConnection()
	{
		return array(
			'userId' =&gt; 'users'
		);
	}
	*/
}

				</pre></div></div><br class="example-break"></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d54e185"></a>4.5.&nbsp;The API endpoint</h2></div></div></div><p>We create a file called news.php in the module/api folder. This file can be
			accessed via http://localhost/index.php/api/news. We define the <code class="methodname">onLoad</code> method
			wich is called when the module was loaded.</p><p>This is now our REST API endpoint where we can make <span class="property">GET</span> and <span class="property">POST</span>
			requests. You can versioning your API by creating a folder structure i.e. put the news.php in the folder "v1"
			and the endpoint url would be http://localhost/index.php/api/v1/news</p><div class="example"><a name="d54e201"></a><p class="title"><b>Example&nbsp;4.5.&nbsp;module/api/news.php</b></p><div class="example-contents"><pre class="programlisting prettyprint">
&lt;?php

namespace api;

use DateTime;
use PSX\Base;
use PSX\Data\ArrayList;
use PSX\Data\Message;
use PSX\Data\WriterResult;
use PSX\Data\WriterInterface;
use PSX\Module\ApiAbstract;
use Test\News\Table;
use Test\News\Handler;

class news extends ApiAbstract
{
	public function onLoad()
	{
		$this-&gt;handler = new Handler(new Table($this-&gt;getSql()));
	}
}
				</pre></div></div><br class="example-break"><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d54e206"></a>4.5.1.&nbsp;Receiving</h3></div></div></div><p>If someone makes an <span class="property">GET</span> request to the endpoint we want return
				the latest news. This method creates in general an <code class="classname">PSX\Data\ResultSet</code> object
				containing multiple <code class="classname">Example\News\Record</code> objects. If we call the <code class="methodname">setResponse</code>
				method with the <code class="classname">PSX\Data\ResultSet</code> object the object is transformed
				into the preferred format (wich was set either by the <span class="property">GET</span> parameter "format"
				or by the "Accept" header field).</p><div class="example"><a name="d54e230"></a><p class="title"><b>Example&nbsp;4.6.&nbsp;module/api/news.php (implement <code class="methodname">getNews</code> method)</b></p><div class="example-contents"><pre class="programlisting prettyprint">
/**
 * @httpMethod GET
 * @path /
 */
public function getNews()
{
	try
	{
		$params    = $this-&gt;getRequestParams();
		$fields    = (array) $params['fields'];
		$resultSet = $this-&gt;handler-&gt;getResultSet($fields, 
			$params['startIndex'], 
			$params['count'], 
			$params['sortBy'], 
			$params['sortOrder'], 
			$this-&gt;getRequestCondition(),
			$this-&gt;getMode());

		$this-&gt;setResponse($resultSet);
	}
	catch(\Exception $e)
	{
		$msg = new Message($e-&gt;getMessage(), false);

		$this-&gt;setResponse($msg);
	}
}

/**
 * @httpMethod GET
 * @path /@supportedFields
 */
public function getSupportedFields()
{
	try
	{
		$array = new ArrayList($this-&gt;handler-&gt;getSupportedFields());

		$this-&gt;setResponse($array);
	}
	catch(\Exception $e)
	{
		$msg = new Message($e-&gt;getMessage(), false);

		$this-&gt;setResponse($msg);
	}
}
					</pre></div></div><br class="example-break"><p>Because we want create <span class="property">Atom</span> and <span class="property">Rss</span> feeds we have to
				set the writer config by overriding the method <code class="methodname">setWriterConfig</code>.</p><div class="example"><a name="d54e249"></a><p class="title"><b>Example&nbsp;4.7.&nbsp;module/api/news.php (implement <code class="methodname">setWriterConfig</code> method)</b></p><div class="example-contents"><pre class="programlisting prettyprint">
protected function setWriterConfig(WriterResult $writer)
{
	switch($writer-&gt;getType())
	{
		case WriterInterface::RSS:
			$title       = 'News';
			$link        = $this-&gt;getConfig()-&gt;get('psx_url');
			$description = 'Example RESTful News API based on PSX ';

			$writer = $writer-&gt;getWriter();
			$writer-&gt;setConfig($title, $link, $description);
			$writer-&gt;setGenerator('psx ' . Base::getVersion());
			break;

		case WriterInterface::ATOM:
			$title   = 'News';
			$id      = $this-&gt;getBase()-&gt;getUrn('news');
			$updated = new DateTime($this-&gt;handler-&gt;getUpdated());

			$writer = $writer-&gt;getWriter();
			$writer-&gt;setConfig($title, $id, $updated);
			$writer-&gt;setGenerator('psx ' . Base::getVersion());
			break;
	}
}
					</pre></div></div><br class="example-break"><p>Because we want that the record can be exported in <span class="property">Atom</span> and <span class="property">Rss</span> we have 
				to specific the method <code class="methodname">export</code> in the <code class="classname">Example\News\Record</code>. By default JSON 
				and XML is supported.</p><div class="example"><a name="d54e271"></a><p class="title"><b>Example&nbsp;4.8.&nbsp;library/Example/News/Record.php (implement <code class="methodname">export</code> method)</b></p><div class="example-contents"><pre class="programlisting prettyprint">
public function export(WriterResult $result)
{
	switch($result-&gt;getType())
	{
		case WriterInterface::RSS:
			$item = $result-&gt;getWriter()-&gt;createItem();

			$item-&gt;setTitle($this-&gt;title);
			$item-&gt;setGuid('urn:uuid:' . Uuid::nameBased('test:' . $this-&gt;id));
			$item-&gt;setDescription($this-&gt;text);

			return $item;
			break;

		case WriterInterface::ATOM:
			$entry = $result-&gt;getWriter()-&gt;createEntry();

			$entry-&gt;setTitle($this-&gt;title);
			$entry-&gt;setId('urn:uuid:' . Uuid::nameBased('test:' . $this-&gt;id));
			$entry-&gt;setUpdated($this-&gt;getDate());
			$entry-&gt;setContent($this-&gt;text, 'html');

			return $entry;
			break;

		default:
			return parent::export($result);
			break;
	}
}
					</pre></div></div><br class="example-break"><p>Here an example <span class="property">GET</span> request with the response</p><div class="example"><a name="d54e284"></a><p class="title"><b>Example&nbsp;4.9.&nbsp;Sample GET request</b></p><div class="example-contents"><pre class="programlisting prettyprint">
GET /index.php/api/news HTTP/1.1
Host: 127.0.0.1
Connection: Keep-Alive
Accept: application/xml
					</pre></div></div><br class="example-break"><div class="example"><a name="d54e289"></a><p class="title"><b>Example&nbsp;4.10.&nbsp;Sample GET response</b></p><div class="example-contents"><pre class="programlisting prettyprint">
HTTP/1.1 200 OK
Date: Wed, 05 Jun 2013 22:18:22 GMT
Server: Apache/2.2.17 (Win32) mod_ssl/2.2.17 OpenSSL/0.9.8o PHP/5.3.4 mod_perl/2.0.4 Perl/v5.10.1
X-Powered-By: psx
Expires: Thu, 09 Oct 1986 01:00:00 GMT
Last-Modified: Thu, 09 Oct 1986 01:00:00 GMT
Cache-Control: no-store, no-cache, must-revalidate
Pragma: no-cache
Content-Length: 288
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Content-Type: application/xml

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;resultset&gt;
 &lt;totalResults&gt;1&lt;/totalResults&gt;
 &lt;startIndex&gt;0&lt;/startIndex&gt;
 &lt;itemsPerPage&gt;16&lt;/itemsPerPage&gt;
 &lt;entry&gt;
  &lt;id&gt;1&lt;/id&gt;
  &lt;userId&gt;1&lt;/userId&gt;
  &lt;title&gt;dsfsd&lt;/title&gt;
  &lt;text&gt;fsdf&lt;/text&gt;
  &lt;date&gt;2013-06-05 23:21:00&lt;/date&gt;
 &lt;/entry&gt;
&lt;/resultset&gt;
					</pre></div></div><br class="example-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d54e294"></a>4.5.2.&nbsp;Inserting</h3></div></div></div><p>If someone makes a <span class="property">POST</span> request we want insert the news in
				the table. We create a new <code class="classname">Example\News\Record</code> object and import the
				request data into the record.</p><div class="example"><a name="d54e305"></a><p class="title"><b>Example&nbsp;4.11.&nbsp;module/api/news.php (implement <code class="methodname">insertNews</code> method)</b></p><div class="example-contents"><pre class="programlisting prettyprint">
/**
 * @httpMethod POST
 * @path /
 */
public function insertNews()
{
	try
	{
		$record = $this-&gt;handler-&gt;getRecord();
		$record-&gt;import($this-&gt;getRequest());

		// insert
		$this-&gt;handler-&gt;create($record);


		$msg = new Message('You have successful create a ' . $record-&gt;getName(), true);

		$this-&gt;setResponse($msg);
	}
	catch(\Exception $e)
	{
		$msg = new Message($e-&gt;getMessage(), false);

		$this-&gt;setResponse($msg);
	}
}
					</pre></div></div><br class="example-break"><p>Here an example <span class="property">POST</span> request to the API endpoint</p><div class="example"><a name="d54e318"></a><p class="title"><b>Example&nbsp;4.12.&nbsp;Sample POST request</b></p><div class="example-contents"><pre class="programlisting prettyprint">
POST /projects/psx/public/index.php/news HTTP/1.1
Host: 127.0.0.1
User-Agent: Lynx 2.8.7
Accept: application/xml
Content-Type: application/xml

&lt;news&gt;
	&lt;userId&gt;1&lt;/userId&gt;
	&lt;title&gt;foo&lt;/title&gt;
	&lt;text&gt;bar&lt;/text&gt;
&lt;/news&gt;
					</pre></div></div><br class="example-break"><div class="example"><a name="d54e323"></a><p class="title"><b>Example&nbsp;4.13.&nbsp;Sample POST response</b></p><div class="example-contents"><pre class="programlisting prettyprint">
HTTP/1.1 200 OK
Date: Wed, 05 Jun 2013 22:20:35 GMT
Server: Apache/2.2.17 (Win32) mod_ssl/2.2.17 OpenSSL/0.9.8o PHP/5.3.4 mod_perl/2.0.4 Perl/v5.10.1
X-Powered-By: psx
Expires: Thu, 09 Oct 1986 01:00:00 GMT
Last-Modified: Thu, 09 Oct 1986 01:00:00 GMT
Cache-Control: no-store, no-cache, must-revalidate
Pragma: no-cache
Content-Length: 133
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Content-Type: application/xml

&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;message&gt;
 &lt;text&gt;You have successful create a news&lt;/text&gt;
 &lt;success&gt;true&lt;/success&gt;
&lt;/message&gt;
					</pre></div></div><br class="example-break"></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d54e328"></a>4.6.&nbsp;Conclusion</h2></div></div></div><p>This example has shown you howto build an API with PSX wich serves content
			in <span class="property">Atom</span>, <span class="property">RSS</span>, <span class="property">Json</span> and
			<span class="property">XML</span> on an <span class="property">GET</span> request. Also it is possible to
			insert new records with a <span class="property">POST</span> request. You can specify the fields
			wich are selected with the parameter fields i.e. "fields=id,title" to select only
			the id and title.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="api-authorization"></a>Chapter&nbsp;5.&nbsp;API authorization</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="sect1"><a href="#d54e357">5.1. Basic authentication</a></span></dt><dt><span class="sect1"><a href="#d54e367">5.2. Oauth authentication</a></span></dt></dl></div><p>It is often the case that you want that only registered users can POST new entries to 
		the API endpoint. In this case the user has to authorize before submitting a new record. PSX
		offers several authorization methods for your API. In this chapter we will look at different 
		authentication methods and howto implement them.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d54e357"></a>5.1.&nbsp;Basic authentication</h2></div></div></div><p>Basic authentication is the most simple authentication method where a user provides
			an username and password in the header. Note if you use basic authentication you should
			use https since the username and password is transported in plaintext over the wire.
			Add the following method to the news API in order to add basic authentication.</p><div class="example"><a name="d54e362"></a><p class="title"><b>Example&nbsp;5.1.&nbsp;module/api/news.php (add basic authentication)</b></p><div class="example-contents"><pre class="programlisting prettyprint">
use PSX\Dispatch\RequestFilter\BasicAuthentication;

...

public function getRequestFilter()
{
	$auth = new BasicAuthentication(function($username, $password){

		if($username == '[username]' &amp;&amp; $password == '[passsword]')
		{
			return true;
		}

		return false;

	});

	return array($auth);
}
				</pre></div></div><br class="example-break"></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d54e367"></a>5.2.&nbsp;Oauth authentication</h2></div></div></div><p>-</p><div class="example"><a name="d54e372"></a><p class="title"><b>Example&nbsp;5.2.&nbsp;module/api/news.php (add oauth authentication)</b></p><div class="example-contents"><pre class="programlisting prettyprint">
use PSX\Dispatch\RequestFilter\OauthAuthentication;
use PSX\Oauth\Provider\Data\Consumer;

...

public function getRequestFilter()
{
	$auth = new OauthAuthentication(function($consumerKey, $token){

		// this is only to illustrate what to return. Normally you have to check
		// - is it a valid consumerKey
		// - does the token belongs to an valid request with a valid status
		// - is the token not expired
		// PSX calculates and compares the signature if you return an consumer.
		// For more informations see http://tools.ietf.org/html/rfc5849
		if($consumerKey == '[consumerKey]' &amp;&amp; $token == '[token]')
		{
			return new Consumer('[consumerKey]', '[consumerSecret]', '[token]', '[tokenSecret]');
		}

		return false;

	});

	return array($auth);
}
				</pre></div></div><br class="example-break"></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="oauth-based-api-authorization"></a>Chapter&nbsp;6.&nbsp;Oauth implementation</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="sect1"><a href="#d54e382">6.1. Setting up the table</a></span></dt><dt><span class="sect1"><a href="#d54e394">6.2. Oauth endpoints</a></span></dt><dd><dl><dt><span class="sect2"><a href="#temporary-credential-request">6.2.1. Temporary Credential Request</a></span></dt><dt><span class="sect2"><a href="#resource-owner-authorization">6.2.2. Resource Owner Authorization</a></span></dt><dt><span class="sect2"><a href="#token-request">6.2.3. Token Request</a></span></dt></dl></dd><dt><span class="sect1"><a href="#d54e459">6.3. Protect the API endpoint</a></span></dt><dd><dl><dt><span class="sect2"><a href="#d54e469">6.3.1. Inserting</a></span></dt></dl></dd><dt><span class="sect1"><a href="#d54e484">6.4. Conclusion</a></span></dt></dl></div><p>If you want offer an Oauth endpoint for applications PSX offers some classes to implement
		the Oauth 1.0 specification. In the following section we will implement a bas Oauth endpoint
		where a client can get tokens and access an protected API. More informations about Oauth at
		http://tools.ietf.org/html/rfc5849.</p><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d54e382"></a>6.1.&nbsp;Setting up the table</h2></div></div></div><p>In order to store the Oauth requests we use the following table</p><div class="example"><a name="d54e387"></a><p class="title"><b>Example&nbsp;6.1.&nbsp;<span class="database">request</span> table</b></p><div class="example-contents"><pre class="programlisting prettyprint">
CREATE TABLE IF NOT EXISTS `request` (
  `id` int(10) NOT NULL AUTO_INCREMENT,
  `ip` varchar(128) NOT NULL,
  `token` varchar(40) NOT NULL,
  `tokenSecret` varchar(40) NOT NULL,
  `nonce` varchar(32) NOT NULL,
  `verifier` varchar(16) DEFAULT NULL,
  `authorized` int(1) NOT NULL DEFAULT '0',
  `callback` varchar(256) DEFAULT NULL,
  `exchangeDate` datetime DEFAULT NULL,
  `authorizationDate` datetime DEFAULT NULL,
  `insertDate` datetime NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `token` (`token`),
  UNIQUE KEY `tokenSecret` (`tokenSecret`),
  UNIQUE KEY `nonce` (`nonce`),
  UNIQUE KEY `verifier` (`verifier`)
) ENGINE=MyISAM  DEFAULT CHARSET=utf8 ;
				</pre></div></div><br class="example-break"></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d54e394"></a>6.2.&nbsp;Oauth endpoints</h2></div></div></div><p>In order to enable Oauth authentication we have to implement the following endpoints like
			defined in the specification.</p><div class="informaltable"><table class="table" border="1"><colgroup><col><col></colgroup><thead><tr><th>Endpoint</th><th>Location</th></tr></thead><tbody><tr><td><a class="link" href="#temporary-credential-request" title="6.2.1.&nbsp;Temporary Credential Request">Temporary Credential Request</a></td><td>http://localhost/index.php/api/request</td></tr><tr><td><a class="link" href="#resource-owner-authorization" title="6.2.2.&nbsp;Resource Owner Authorization">Resource Owner Authorization</a></td><td>http://localhost/index.php/api/auth</td></tr><tr><td><a class="link" href="#token-request" title="6.2.3.&nbsp;Token Request">Token Request</a></td><td>http://localhost/index.php/api/access</td></tr></tbody></table></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="temporary-credential-request"></a>6.2.1.&nbsp;Temporary Credential Request</h3></div></div></div><p>This endpoint is for obtaining an temporary credential.</p><div class="example"><a name="d54e431"></a><p class="title"><b>Example&nbsp;6.2.&nbsp;module/api/request.php</b></p><div class="example-contents"><pre class="programlisting prettyprint">
&lt;?php

namespace api;

use PSX\DateTime;
use PSX\Exception;
use PSX\Oauth\Provider\RequestAbstract;
use PSX\Oauth\Provider\Data;

class request extends RequestAbstract
{
	public function onLoad()
	{
		try
		{
			// if we call the handle method the OAuth request is proccessed and
			// the getConsumer() and getResponse() method is called
			$this-&gt;handle();
		}
		catch(\Exception $e)
		{
			header('HTTP/1.1 500 Internal Server Error');

			echo $e-&gt;getMessage();

			if($this-&gt;config['psx_debug'] === true)
			{
				echo "\n\n" . $e-&gt;getTraceAsString();
			}
		}
	}

	protected function getConsumer($consumerKey)
	{
		if($consumerKey == $this-&gt;config['consumer_key'])
		{
			return new Data\Consumer($this-&gt;config['consumer_key'], $this-&gt;config['consumer_secret']);
		}
		else
		{
			throw new Exception('Invalid consumer key');
		}
	}

	protected function getResponse(Data\Consumer $consumer, Data\Request $request)
	{
		// generate tokens
		$token       = sha1(uniqid(mt_rand(), true));
		$tokenSecret = sha1(uniqid(mt_rand(), true));

		// insert request
		$this-&gt;getSql()-&gt;insert('request', array(

			'ip'          =&gt; $_SERVER['REMOTE_ADDR'],
			'token'       =&gt; $token,
			'tokenSecret' =&gt; $tokenSecret,
			'nonce'       =&gt; $request-&gt;getNonce(),
			'callback'    =&gt; $request-&gt;getCallback(),
			'insertDate'  =&gt; date(DateTime::SQL),

		));

		// return response
		$response = new Data\Response();
		$response-&gt;setToken($token);
		$response-&gt;setTokenSecret($tokenSecret);

		return $response;
	}
}

					</pre></div></div><br class="example-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="resource-owner-authorization"></a>6.2.2.&nbsp;Resource Owner Authorization</h3></div></div></div><p>If the Oauth client has obtained the temporary credential the user will be redirected to
				the <span class="property">Resource Owner Authorization</span> endpoint.</p><div class="example"><a name="d54e444"></a><p class="title"><b>Example&nbsp;6.3.&nbsp;module/api/auth.php</b></p><div class="example-contents"><pre class="programlisting prettyprint">
&lt;?php

namespace api;

use PSX\Exception;
use PSX\DateTime;
use PSX\Url;
use PSX\ModuleAbstract;
use PSX\Sql\Condition;

class auth extends ModuleAbstract
{
	public function onLoad()
	{
		$token = isset($_GET['oauth_token']) ? $_GET['oauth_token'] : null;

		if(!empty($token))
		{
			$row = $this-&gt;getSql()-&gt;getRow('SELECT `id`, `ip`, `token`, `authorized`, `callback`, `insertDate` FROM `request` WHERE `token` = ?', array($token));

			if(!empty($row))
			{
				// @todo normally we have to check here whether the current user
				// is authenticated. If not the user has to login. Then a form 
				// should be displayed whether the user wants to grant or deny 
				// the application. If the user allows the application we 
				// approve the request. To simplify things we acccept the 
				// request on load

				// validate
				if($_SERVER['REMOTE_ADDR'] != $row['ip'])
				{
					throw new Exception('Token was requested from another ip');
				}

				if($row['authorized'] != 0)
				{
					throw new Exception('Token was already authorized');
				}

				// @todo check the insertDate whether token is expired

				// generate verifier
				$verifier = substr(sha1(uniqid(mt_rand(), true)), 0, 16);

				// update request
				$con = new Condition(array('id', '=', $row['id']));

				$this-&gt;getSql()-&gt;update('request', array(

					'verifier'          =&gt; $verifier,
					'authorized'        =&gt; 1,
					'authorizationDate' =&gt; date(DateTime::SQL),

				), $con);

				// redirect user or display verifier
				if($row['callback'] != 'oob')
				{
					$url = new Url($row['callback']);
					$url-&gt;addParam('oauth_token', $row['token']);
					$url-&gt;addParam('oauth_verifier', $verifier);

					header('Location: ' . strval($url));
					exit;
				}
				else
				{
					echo '&lt;p&gt;You have successful authorized a token. Please provide the following verifier to your application in order to complete the authorization proccess.&lt;/p&gt;';
					echo '&lt;p&gt;Verifier:&lt;/p&gt;&lt;p&gt;&lt;b&gt;' . $verifier . '&lt;/b&gt;&lt;/p&gt;';
				}
			}
			else
			{
				throw new Exception('Invalid token');
			}
		}
		else
		{
			throw new Exception('Token not set');
		}
	}
}
					</pre></div></div><br class="example-break"></div><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="token-request"></a>6.2.3.&nbsp;Token Request</h3></div></div></div><p>-</p><div class="example"><a name="d54e454"></a><p class="title"><b>Example&nbsp;6.4.&nbsp;module/api/access.php</b></p><div class="example-contents"><pre class="programlisting prettyprint">
&lt;?php

namespace api;

use PSX\DateTime;
use PSX\Exception;
use PSX\Oauth\Provider\AccessAbstract;
use PSX\Oauth\Provider\Data;
use PSX\Sql\Condition;

class access extends AccessAbstract
{
	protected $id;
	protected $nonce;
	protected $verifier;

	public function onLoad()
	{
		try
		{
			// if we call the handle method the OAuth request is proccessed and
			// the getConsumer() and getResponse() method is called
			$this-&gt;handle();
		}
		catch(\Exception $e)
		{
			header('HTTP/1.1 500 Internal Server Error');

			echo $e-&gt;getMessage();

			if($this-&gt;config['psx_debug'] === true)
			{
				echo "\n\n" . $e-&gt;getTraceAsString();
			}

			exit;
		}
	}

	protected function getConsumer($consumerKey, $token)
	{
		if($consumerKey == $this-&gt;config['consumer_key'])
		{
			$row = $this-&gt;getSql()-&gt;getRow('SELECT id, nonce, verifier, token, tokenSecret FROM request WHERE token = ? AND authorized = 1', array($token));

			if(!empty($row))
			{
				$this-&gt;id       = $row['id'];
				$this-&gt;nonce    = $row['nonce'];
				$this-&gt;verifier = $row['verifier'];

				return new Data\Consumer($this-&gt;config['consumer_key'], $this-&gt;config['consumer_secret'], $row['token'], $row['tokenSecret']);
			}
			else
			{
				throw new Exception('Invalid token');
			}
		}
		else
		{
			throw new Exception('Invalid consumer key');
		}
	}

	protected function getResponse(Data\Consumer $consumer, Data\Request $request)
	{
		// validate
		if($this-&gt;nonce == $request-&gt;getNonce())
		{
			throw new Exception('Nonce hasnt changed');
		}

		if($this-&gt;verifier != $request-&gt;getVerifier())
		{
			throw new Exception('Invalid verifier');
		}

		// generate a new access token
		$token       = sha1(uniqid(mt_rand(), true));
		$tokenSecret = sha1(uniqid(mt_rand(), true));

		// update request
		$con = new Condition(array('id', '=', $this-&gt;id));

		$this-&gt;getSql()-&gt;update('request', array(

			'authorized'   =&gt; 2,
			'token'        =&gt; $token,
			'tokenSecret'  =&gt; $tokenSecret,
			'exchangeDate' =&gt; date(DateTime::SQL),

		), $con);

		// return response
		$response = new Data\Response();
		$response-&gt;setToken($token);
		$response-&gt;setTokenSecret($tokenSecret);

		return $response;
	}
}

					</pre></div></div><br class="example-break"></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d54e459"></a>6.3.&nbsp;Protect the API endpoint</h2></div></div></div><p>Now we can protect our API like defined in the "API authorization" chapter. Here
			an simple implementation.</p><div class="example"><a name="d54e464"></a><p class="title"><b>Example&nbsp;6.5.&nbsp;module/api/news.php (add oauth authentication)</b></p><div class="example-contents"><pre class="programlisting prettyprint">
public function getRequestFilter()
{
	$config = $this-&gt;getConfig();
	$sql    = $this-&gt;getSql();

	$auth = new OauthAuthentication(function($consumerKey, $token) use ($config, $sql){

		if($consumerKey == $config['consumer_key'])
		{
			$row = $sql-&gt;getRow('SELECT token, tokenSecret FROM request WHERE token = ? AND authorized = 2', array($token));

			if(!empty($row))
			{
				return new Data\Consumer($config['consumer_key'], $config['consumer_secret'], $row['token'], $row['tokenSecret']);
			}
			else
			{
				throw new Exception('Invalid token');
			}
		}
		else
		{
			throw new Exception('Invalid consumer key');
		}

	});

	return array($auth);
}
				</pre></div></div><br class="example-break"><div class="sect2"><div class="titlepage"><div><div><h3 class="title"><a name="d54e469"></a>6.3.1.&nbsp;Inserting</h3></div></div></div><p>Here an example Oauth request to insert a news</p><div class="example"><a name="d54e474"></a><p class="title"><b>Example&nbsp;6.6.&nbsp;Sample POST request</b></p><div class="example-contents"><pre class="programlisting prettyprint">
POST /index.php/api/news HTTP/1.1
Host: 127.0.0.1
Connection: Keep-Alive
Content-Type: application/xml
Authorization: OAuth realm="Aletheia", oauth_signature="iH%2Frqr8h%2Bv74G0UhV2i9ikasSxM%3D", oauth_version="1.0", oauth_nonce="b86440fa6e025b41820cdf8f6124ceaa", oauth_signature_method="HMAC-SHA1", oauth_consumer_key="19b6db8e0de8a287f65a2ae83d6b4f88", oauth_token="88ad358b1e983ac293b290b7547c3dbc28bc92f7", oauth_timestamp="1370551822"
Content-Length: 72
Expect: 100-continue

&lt;news&gt;
	&lt;userId&gt;1&lt;/userId&gt;
	&lt;title&gt;foo&lt;/title&gt;
	&lt;text&gt;bar&lt;/text&gt;
&lt;/news&gt;
					</pre></div></div><br class="example-break"><div class="example"><a name="d54e479"></a><p class="title"><b>Example&nbsp;6.7.&nbsp;Sample POST response</b></p><div class="example-contents"><pre class="programlisting prettyprint">
HTTP/1.1 200 OK
Date: Thu, 06 Jun 2013 20:50:22 GMT
Server: Apache/2.2.17 (Win32) mod_ssl/2.2.17 OpenSSL/0.9.8o PHP/5.3.4 mod_perl/2.0.4 Perl/v5.10.1
X-Powered-By: psx
Expires: Thu, 09 Oct 1986 01:00:00 GMT
Last-Modified: Thu, 09 Oct 1986 01:00:00 GMT
Cache-Control: no-store, no-cache, must-revalidate
Pragma: no-cache
Content-Length: 59
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Content-Type: application/json

{"text":"You have successful create a news","success":true}
					</pre></div></div><br class="example-break"></div></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d54e484"></a>6.4.&nbsp;Conclusion</h2></div></div></div><p>This was an basic example howto create an Oauth endpoint and to protect your API.</p><p>Note: This is an example implementation to show you the basic functionality howto use
			the Oauth classes of PSX. Because of simplicity we use only a single consumer key and consumer secret
			normally you would save those in a table and generate per application a consumer key and secret. Please
			see the <a class="ulink" href="http://amun.phpsx.org" target="_top">Amun</a> project for a real implementation of the OAuth
			classes.</p></div></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="help"></a>Chapter&nbsp;7.&nbsp;Help</h1></div></div></div><p>Because PSX is in an early stage the manual is not complete. I appreciate every help in making
		this documentation better. The documentation is writte in XML against the docbook
		specification. You can checkout the current version of this manual via SVN. The XML file is in
		doc/docbook/manual.xml. If you have made some changes that you want commit please contact me.</p><div class="orderedlist"><p class="title"><b>Further reading about PSX</b></p><ol class="orderedlist" type="I"><li class="listitem"><p>Repository: <a class="ulink" href="https://github.com/k42b3/psx" target="_top">https://github.com/k42b3/psx</a></p></li><li class="listitem"><p>Bugtracker: <a class="ulink" href="https://github.com/k42b3/psx/issues" target="_top">https://github.com/k42b3/psx/issues</a></p></li><li class="listitem"><p>Website: <a class="ulink" href="http://phpsx.org" target="_top">http://phpsx.org</a></p></li><li class="listitem"><p>Examples: <a class="ulink" href="http://example.phpsx.org" target="_top">http://example.phpsx.org</a></p></li></ol></div></div></div></div></body></html>